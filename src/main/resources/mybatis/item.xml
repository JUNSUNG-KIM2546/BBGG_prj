<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="item">

	<resultMap type="kr.ac.kopo.item.web.ItemVO" id="ItemMap">
    <id property="itemNo" column="item_no" />
    <result property="partnerNo" column="partner_no" />
    <result property="leaseOrMonth" column="lease_or_month" />
    <result property="itemType" column="item_type" />
    <result property="address" column="address" />
    <result property="address2" column="address2" />
    <result property="dong" column="dong" />
    <result property="ho" column="ho" />
    <result property="moveInAt" column="move_in_at" />
    <result property="moveInDate" column="move_in_date" />
    <result property="itemSize" column="item_size" />
    <result property="buildingFloor" column="building_floor" />
    <result property="itemFloor" column="item_floor" />
    <result property="itemCount" column="item_count" />
    <result property="bathAt" column="bath_at" />
    <result property="elevatorAt" column="elevator_at" />
    <result property="parkingAt" column="parking_at" />
    <result property="manageFeeAt" column="manage_fee_at" />
    <result property="manageFee" column="manage_fee" />
    <result property="memoShort" column="memo_short" />
    <result property="memoDetail" column="memo_detail" />
    <result property="registDate" column="regist_date" />
    <result property="updateDate" column="update_date" />
    <result property="useAt" column="use_at" />
    <result property="lat" column="lat" />
    <result property="lng" column="lng" />
    
    <!-- 추가된 부분 -->
    <result property="leasePrice" column="price" />
    <result property="depositFee" column="deposit_fee" />
    <result property="monthPrice" column="price" />
    <result property="wishCount" column="wish_count"/>
	
	<collection property="fileVOList" column="item_file_no" select="selectFile" javaType="ArrayList" ofType="FileVO" autoMapping="true">
		<id property="fileNo" column="file_no"/>
	</collection>    
</resultMap>

	
	<select id="itemList" resultType="itemVO">
		SELECT i.*, l.lease_price, m.deposit_fee, m.month_price<!-- , f.* -->
		FROM tbl_item i 
		LEFT JOIN tbl_lease l ON i.item_no = l.item_no 
		LEFT JOIN tbl_month m ON i.item_no = m.item_no
		<!-- LEFT JOIN tbl_item_file f ON i.item_no = f.item_no -->
		<where>
			<if test="search != null and !search.equals('')">
				(i.address LIKE CONCAT('%', #{search}, '%') OR i.address2 LIKE CONCAT('%', #{search}, '%'))
				<!-- AND f.file_no = (
				    SELECT MIN(file_no)
				    FROM tbl_item_file
				    WHERE item_no = i.item_no
				) -->
				<if test="itemType != null and !itemType.equals('')">
					AND i.item_type LIKE #{itemType}
				</if>
				<if test="leaseOrMonth != null and !leaseOrMonth.equals('')">
					AND i.lease_or_month LIKE #{leaseOrMonth}
				</if>
			</if>
		</where>
		ORDER BY i.regist_date DESC
	</select>
	
	<!-- <select id="itemSelect" resultType="itemVO">
		SELECT 
		
		<choose>
	        <when test="leaseOrMonth == 'lease'">
	            (SELECT lease_price FROM tbl_lease  WHERE tbl_lease.item_no = tbl_item.item_no) AS "전세가격",
	        </when>
	        <otherwise>
	            (SELECT deposit_fee FROM tbl_month  WHERE tbl_month.item_no = tbl_item.item_no) AS "보증금",
	            (SELECT month_price FROM tbl_month  WHERE tbl_month.item_no = tbl_item.item_no) AS "월세가격",
	        </otherwise>
	    </choose>
		tbl_item.*
		FROM tbl_item
		WHERE item_No = #{itemNo}
	</select> -->
	
	<select id="lomSelect" resultType="String">
		SELECT tbl_item.lease_or_month
		FROM tbl_item
		WHERE tbl_item.item_no = #{itemNo}
	</select>
	
	<select id="itemSelect" resultMap="ItemMap">
		<choose>
	        <when test="leaseOrMonth == 'lease'">
	        	SELECT tbl_item.*, tbl_lease.*
				FROM tbl_item JOIN tbl_lease ON tbl_item.item_no = tbl_lease.item_no
				WHERE tbl_lease.item_no = #{itemNo}
	        </when>
	        <otherwise>
	            SELECT tbl_item.*, tbl_month.*
				FROM tbl_item JOIN tbl_month ON tbl_item.item_no = tbl_month.item_no
				WHERE tbl_month.item_no = #{itemNo}
	        </otherwise>
	    </choose>
	</select>
	
	<select id="partItemList" resultMap="ItemMap">
		SELECT 
		    ti.item_no,
		    ti.item_type,
		    ti.lease_or_month,
		    ti.address2,
		    ti.address,
		    ti.regist_date,
		    ti.use_at,
		    ti.item_size,
		    ti.item_count,
		    ti.bath_at,
		    CASE 
		        WHEN ti.lease_or_month = 'lease' THEN tl.lease_price
		        WHEN ti.lease_or_month = 'month' THEN tm.month_price
		        ELSE NULL
		    END AS price,
		    tm.deposit_fee, 
		    ti.item_floor,
		    ti.manage_fee,
		    ti.memo_short
		FROM tbl_item ti
		LEFT JOIN tbl_lease tl ON ti.item_no = tl.item_no AND ti.lease_or_month = 'lease'
		LEFT JOIN tbl_month tm ON ti.item_no = tm.item_no AND ti.lease_or_month = 'month'
		WHERE ti.use_at IN ('Y', 'C')
			AND ti.partner_no = #{partnerNo}
		ORDER BY ti.regist_date DESC
	</select>
	
	<update id="updateStatus">
	    UPDATE tbl_item
	    SET use_at = CASE
	        WHEN use_at = 'C' THEN 'Y'
	        WHEN use_at = 'Y' THEN 'C'
	        ELSE use_at
	    END
	    WHERE item_no = #{itemNo}
	</update>
	
	<select id="selectStatus" resultType="java.lang.String">
		SELECT use_at
		FROM tbl_item
		WHERE item_no = #{itemNo}
	</select>

	<update id="deleteItem">
	    UPDATE tbl_item
	    SET use_at = 'N'
	    WHERE item_no = #{itemNo}
	</update>
	
	<select id="itemDetail" resultMap="ItemMap">
			SELECT 
		   i.item_no,
	       i.partner_no,
	       i.item_type,
	       i.address,
	       i.dong,
	       i.ho,
	       CASE WHEN i.move_in_at = 'Y' THEN i.move_in_date ELSE NULL END AS move_in_date,
	       i.item_size,
	       i.building_floor,
	       i.item_floor,
	       i.item_count,
	       i.bath_at,
	       i.elevator_at,
	       i.parking_at,
	       CASE WHEN i.manage_fee_at = 'Y' THEN i.manage_fee ELSE NULL END AS manage_fee,
	       i.memo_short,
	       i.memo_detail,
	       i.regist_date,
	       i.update_date,
	       i.use_at,
	       i.lat,
	       i.lng,
	       i.address2,
	       COALESCE(l.lease_price, m.month_price) AS price,
	       m.deposit_fee
	FROM tbl_item i
	LEFT JOIN tbl_lease l ON i.item_no = l.item_no AND i.lease_or_month = 'lease'
	LEFT JOIN tbl_month m ON i.item_no = m.item_no AND i.lease_or_month = 'month'
	WHERE i.use_at In ('Y', 'C')
		AND i.item_no = #{itemNo};
	</select>
	
	<insert id="addItem">
		INSERT INTO tbl_item
			(
			partner_no, 
			item_type, 
			address, 
			dong, 
			ho, 
			move_in_at, 
			move_in_date, 
			item_size, 
			building_floor, 
			item_floor, 
			item_count, 
			bath_at, 
			elevator_at, 
			parking_at, 
			manage_fee_at, 
			manage_fee, 
			memo_short, 
			memo_detail, 
			regist_date, 
			use_at, 
			lat, 
			lng, 
			address2, 
			lease_or_month
			)
			VALUES(
			#{partnerNo}, 
			#{itemType}, 
			#{address}, 
			#{dong}, 
			#{ho}, 
			#{moveInAt}, 
			<choose>
		        <when test="moveInDate == null">
		            NOW(),
		        </when>
		        <otherwise>
		            #{moveInDate},
		        </otherwise>
		    </choose>
			#{itemSize}, 
			#{buildingFloor}, 
			#{itemFloor}, 
			#{itemCount}, 
			#{bathAt}, 
			#{elevatorAt}, 
			#{parkingAt}, 
			#{manageFeeAt}, 
			#{manageFee}, 
			#{memoShort}, 
			#{memoDetail}, 
			NOW(), 
			'Y', 
			#{lat}, 
			#{lng}, 
			#{address2}, 
			#{leaseOrMonth}
			)
		<selectKey keyProperty="itemNo" resultType="Long" order="AFTER">
       		SELECT LAST_INSERT_ID()
       </selectKey>
	</insert>
	
	<insert id="leaseAdd">
	    INSERT INTO tbl_lease(lease_price, item_no)
		VALUES (#{leasePrice}, #{itemNo})
	</insert>
	
	<insert id="monthAdd">
		INSERT INTO tbl_month(deposit_fee, month_price, item_no)
		VALUES (#{depositFee}, #{monthPrice}, #{itemNo})
	</insert>
	
	<select id="selectFile" resultType="FileVO">
		SELECT 
			file_no
			, saved_name
			, original_name
			, file_path
			, file_ext
			, regist_date
			, file_size
			, item_no
		FROM tbl_item_file
		WHERE item_no = #{itemNo}
	</select>
	
	<select id="selectRecentList" resultMap="ItemMap">
		SELECT 
		    ti.item_no,
		    ti.lease_or_month,
		    ti.address2,
		    ti.address,
		    ti.item_size,
		    ti.item_count,
		    ti.bath_at,
		    CASE 
		        WHEN ti.lease_or_month = 'lease' THEN tl.lease_price
		        WHEN ti.lease_or_month = 'month' THEN tm.month_price
		        ELSE NULL
		    END AS price,
		    tm.deposit_fee
		FROM tbl_item ti
		LEFT JOIN tbl_lease tl ON ti.item_no = tl.item_no AND ti.lease_or_month = 'lease'
		LEFT JOIN tbl_month tm ON ti.item_no = tm.item_no AND ti.lease_or_month = 'month'
		WHERE ti.use_at = 'Y'
		ORDER BY ti.regist_date DESC
		LIMIT 6
	</select>
	
	<update id="viewCount">
	    UPDATE tbl_item
	    SET view_count = view_count + 1
	    WHERE item_no = #{itemNo}
	</update>
	
	<select id="selectItemFile" resultType="FileVO">
    	SELECT *
		FROM tbl_item_file tif 
		WHERE tif.item_no = #{itemNo}
		LIMIT 1
    </select>
    
    <select id="selectPopularList" resultMap="ItemMap">
    	SELECT
		    i.item_no,
		    COUNT(w.item_no) AS wish_count,
		    i.partner_no,
		    i.item_type,
		    i.address,
		    i.item_size,
		    i.bath_at,
		    i.item_count,
		    i.regist_date,
		    i.use_at,
		    i.address2,
		    i.lease_or_month,
		    i.view_count,
		    m.deposit_fee, 
		    COALESCE(l.lease_price, m.month_price) AS price
		FROM tbl_item AS i
		LEFT JOIN tbl_wish AS w ON i.item_no = w.item_no
		LEFT JOIN tbl_lease l ON i.item_no = l.item_no AND i.lease_or_month = 'lease'
		LEFT JOIN tbl_month m ON i.item_no = m.item_no AND i.lease_or_month = 'month'
		WHERE i.use_at IN ('Y','C')    
		GROUP BY i.item_no
		ORDER BY wish_count DESC
		LIMIT 3;
    </select>
	
</mapper>