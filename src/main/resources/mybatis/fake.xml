<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="fake">
	<sql id="search">
		SELECT tbl_fake.* FROM tbl_fake 
		
		<where>
			<if test="search == 1">
				tbl_fake.item_no = #{keyword}
			</if>
			
			<if test="search == 2">
				tbl_partner.comp_name LIKE CONCAT(CONCAT('%', #{keyword}), '%')
			</if>
			
			<if test="search == 3">
				tbl_fake.user_no LIKE CONCAT(CONCAT('%', #{keyword}), '%')
			</if>
			
			<if test="search == 4">
				tbl_fake.use_at LIKE CONCAT(CONCAT('%', #{keyword}), '%')
			</if>
		</where>
		
		ORDER BY tbl_fake.fake_no
	</sql>

	<select id="selectList" resultType="fakeVO">
		SELECT sup.*
		FROM (SELECT sub.*, ROW_NUMBER() OVER() as rnum 
			  FROM (SELECT tf.*, tp.comp_name
					FROM tbl_fake AS tf, tbl_item AS ti, tbl_partner AS tp
					WHERE tf.item_no  = ti.item_no 
						AND ti.partner_no = tp.partner_no 
					ORDER BY tf.regist_date DESC) AS sub
			  ORDER BY rnum) AS sup
			  
		<if test="perPage != 0">
			<![CDATA[
			  WHERE rnum > ((#{page}-1)*#{perPage}) AND rnum <= (#{page}*#{perPage}) 
			]]>
		</if>
	</select>
	
	<select id="total" resultType="Integer">
		SELECT COUNT(*) FROM (<include refid="search"></include>) as sub
	</select>

	<insert id="insert">
		INSERT INTO tbl_fake (
							item_no, 
							user_no, 
							fake_check1, 
							fake_check2, 
							fake_check3, 
							fake_content, 
							use_at, 
							agree_at,
							regist_date)
		VALUES (#{itemNo}, 
				(SELECT user_no 
				FROM tbl_user
				WHERE user_id = #{userId}
        		), 
				#{fakeVO.fakeCheck1}, 
				#{fakeVO.fakeCheck2}, 
				#{fakeVO.fakeCheck3}, 
				#{fakeVO.fakeContent}, 
				#{fakeVO.useAt}, 
				#{fakeVO.agreeAt},
				NOW()
				)
	</insert>
	
	<insert id="insertFile">
		INSERT INTO tbl_fake_file (
								fake_no, 
								original_file_name,
								file_extension,
								unique_file_name,
								saved_file_name, 
								file_size, 	
								use_at)
		VALUES (#{fakeVO.fakeNo}, 
				#{uploadVO.originalFileName}, 
				#{uploadVO.fileExtension}, 
				#{uploadVO.uniqueFileName}, 
				#{uploadVO.savedFileName}, 
				#{uploadVO.fileSize}, 
				#{uploadVO.useAt}
				)
	</insert>
	
	<update id=""></update>

</mapper>