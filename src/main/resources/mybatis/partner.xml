<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="partner">

	<insert id="add">
		INSERT INTO tbl_partner
		(
			user_id
			, user_pw
			, partner_name
			, comp_name
			, comp_address
			, phone
			, regist_num
			, comp_num
			, regist_date
			, use_at
		)
		VALUES (
			#{userId}
			, #{userPw}
			, #{partnerName}
			, #{compName}
			, #{compAddress}
			, #{phone}
			, #{registNum}
			, #{compNum}
			, NOW()
			, 'Y'
		)
		<selectKey keyProperty="partnerNo" order="AFTER" resultType="Long">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>

	 
	<select id="total" resultType="Integer">
		SELECT COUNT(*) 
		FROM  tbl_partner
	</select>
	
	<select id="list" resultType="PartnerVO">
		SELECT 
			partner_no
			, user_id
			, partner_name
			, comp_name
			, phone
			, regist_date
		FROM  tbl_partner
		WHERE use_at = 'Y'
	</select>
	
	<select id="select" resultType="PartnerVO">
		SELECT 
			partner_no
			, comp_name
			, comp_address
			, comp_num
			, partner_name
			, regist_num
			, phone
			, memo
			, regist_date
		FROM  tbl_partner
		WHERE partner_no = #{partnerNo}
	</select>

	 <select id="detail" resultType="PartnerVO">
		SELECT 
			tp.partner_no
			, comp_name
			, comp_address 
			, partner_name 
			, regist_num 
			, phone
			FROM tbl_partner tp JOIN tbl_item ti ON (tp.partner_no = ti.partner_no)
			WHERE ti.item_no = #{itemNo}
	</select> 

	
	<update id="update">
		UPDATE tbl_partner
		SET 
			comp_name = #{compName}
			, comp_address = #{compAddress}
			, regist_num = #{registNum}
			, comp_num = #{compNum}
			, phone = #{phone}
			, memo = #{memo}
			, update_date = now()
		WHERE partner_no = #{partnerNo}
	</update>
	
	<delete id="delete">
		DELETE FROM tbl_partner
		WHERE partner_no = #{partnerNo}
	</delete>
	
		<select id="respWaitCount" resultType="RespVO">
		SELECT date_list.date, IFNULL(tn_count.count, 0) AS count
		FROM (
		    SELECT DATE(NOW()) AS date
		    UNION SELECT DATE(DATE_SUB(NOW(), INTERVAL 1 DAY))
		    UNION SELECT DATE(DATE_SUB(NOW(), INTERVAL 2 DAY))
		    UNION SELECT DATE(DATE_SUB(NOW(), INTERVAL 3 DAY))
		    UNION SELECT DATE(DATE_SUB(NOW(), INTERVAL 4 DAY))
		) AS date_list
		LEFT JOIN (
		    SELECT DATE(regist_date) AS date, COUNT(*) AS count
		    FROM tbl_note tn 
		    WHERE use_at = 'Y'
		    AND partner_no = #{partnerNo}
		    AND regist_date BETWEEN DATE_SUB(NOW(), INTERVAL 4 DAY) AND NOW()
		    GROUP BY DATE(regist_date)
		) AS tn_count
		ON date_list.date = tn_count.date
		ORDER BY date_list.date;
				
	</select>

	<select id="respCompCount" resultType="RespVO">
		SELECT date_list.date, IFNULL(tn_count.count, 0) AS count
		FROM (
		    SELECT DATE(NOW()) AS date
		    UNION SELECT DATE(DATE_SUB(NOW(), INTERVAL 1 DAY))
		    UNION SELECT DATE(DATE_SUB(NOW(), INTERVAL 2 DAY))
		    UNION SELECT DATE(DATE_SUB(NOW(), INTERVAL 3 DAY))
		    UNION SELECT DATE(DATE_SUB(NOW(), INTERVAL 4 DAY))
		) AS date_list
		LEFT JOIN (
		    SELECT DATE(regist_date) AS date, COUNT(*) AS count
		    FROM tbl_note tn 
		    WHERE use_at = 'C'
		    AND partner_no = #{partnerNo}
		    AND regist_date BETWEEN DATE_SUB(NOW(), INTERVAL 4 DAY) AND NOW()
		    GROUP BY DATE(regist_date)
		) AS tn_count
		ON date_list.date = tn_count.date
		ORDER BY date_list.date;
	</select>
	
	<select id="itemWaitCount" resultType="integer">
		SELECT COUNT(*)
		FROM tbl_item ti 
		WHERE use_at = 'Y'
		AND partner_no = #{partnerNo}
	</select>
	
	
	<select id="itemCompCount" resultType="integer">
		SELECT COUNT(*)
		FROM tbl_item ti 
		WHERE use_at = 'C'
		AND partner_no = #{partnerNo}
	</select>

	<select id="selectFile" resultType="FileVO">
		SELECT 
			file_no
			, saved_name
			, original_name
			, file_path
			, file_ext
			, regist_date
			, file_size
			, partner_no
		FROM tbl_partner_file
		WHERE partner_no = #{partnerNo}
	</select>
	
	<select id="selectItemList" resultType="ItemVO">
		SELECT 
		    ti.item_no,
		    ti.lease_or_month,
		    ti.address2,
		    ti.address,
		    ti.item_size,
		    ti.item_count,
		    ti.bath_at,
		    CASE 
		        WHEN ti.lease_or_month = 'lease' THEN tl.lease_price
		        WHEN ti.lease_or_month = 'month' THEN tm.month_price
		        ELSE NULL
		    END AS price,
		    tm.deposit_fee
		FROM tbl_item ti
		LEFT JOIN tbl_lease tl ON ti.item_no = tl.item_no AND ti.lease_or_month = 'lease'
		LEFT JOIN tbl_month tm ON ti.item_no = tm.item_no AND ti.lease_or_month = 'month'
		WHERE ti.use_at = 'Y' 
		AND ti.partner_no = #{partnerNo}
		ORDER BY ti.regist_date DESC
		LIMIT 6
	</select>

	<select id="selectRespList" resultType="PartnerVO">
		SELECT
		  p.partner_no,
		  p.comp_name,
		  p.partner_name,
		  COUNT(CASE WHEN n.use_at = 'C' THEN 1 END) AS completed_note_count,
		  COUNT(*) AS total_note_count
		FROM
		  tbl_partner p
		LEFT JOIN
		  tbl_note n ON p.partner_no = n.partner_no
		GROUP BY
		  p.partner_no, p.comp_name, p.partner_name
		ORDER BY completed_note_count DESC
		LIMIT 4			
	</select>
</mapper>